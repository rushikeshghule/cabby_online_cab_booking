{% extends 'base.html' %}
{% load static %}

{% block title %}Rider Dashboard - Cabby{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Rider Profile Header -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card border-0 bg-gradient-primary text-white shadow-lg" style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            <div class="rounded-circle bg-white d-flex align-items-center justify-content-center mx-auto" style="width: 100px; height: 100px; font-size: 40px; color: #6a11cb;">
                                {{ user.get_initials }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h2 class="display-6 fw-bold mb-1">Welcome, {{ user.get_full_name|default:user.username }}!</h2>
                            <p class="lead opacity-75 mb-0">
                                Ready for your next journey?
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <a href="{% url 'book_ride' %}" class="btn btn-lg fw-bold btn-light text-primary shadow">
                                <i class="fas fa-taxi me-2"></i>Book a Ride
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm rounded-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stats-icon bg-primary text-white rounded-circle me-3">
                            <i class="fas fa-route"></i>
                        </div>
                        <h5 class="card-title fw-bold mb-0">Total Rides</h5>
                    </div>
                    <p class="display-4 fw-bold text-primary mb-0">{{ user.rides_as_rider.count }}</p>
                    <p class="text-muted">Your journey with Cabby</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm rounded-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stats-icon bg-success text-white rounded-circle me-3">
                            <i class="fas fa-car"></i>
                        </div>
                        <h5 class="card-title fw-bold mb-0">Active Ride</h5>
                    </div>
                    {% if active_ride %}
                        <div class="active-ride-status mb-2">
                            <span class="pulse-dot me-2"></span>
                            <span class="fw-bold">In Progress</span>
                        </div>
                        <p class="text-muted mb-3">{{ active_ride.pickup_address|truncatechars:30 }} to {{ active_ride.dropoff_address|truncatechars:30 }}</p>
                        <a href="{% url 'ride_detail' active_ride.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>View Details
                        </a>
                    {% else %}
                        <p class="text-muted mb-0">No active rides at the moment</p>
                        <div class="text-center mt-3">
                            <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=200&q=80" 
                                 alt="No active ride" class="img-fluid rounded" style="max-height: 100px; object-fit: cover;">
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm rounded-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stats-icon bg-warning text-white rounded-circle me-3">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <h5 class="card-title fw-bold mb-0">Saved Locations</h5>
                    </div>
                    <div class="saved-locations mb-3">
                        {% if user.rider_profile.home_address %}
                            <div class="saved-location mb-2">
                                <p class="mb-1"><i class="fas fa-home text-primary me-2"></i>Home</p>
                                <p class="text-muted small mb-0">{{ user.rider_profile.home_address|truncatechars:40 }}</p>
                            </div>
                        {% endif %}
                        {% if user.rider_profile.work_address %}
                            <div class="saved-location mb-2">
                                <p class="mb-1"><i class="fas fa-building text-primary me-2"></i>Work</p>
                                <p class="text-muted small mb-0">{{ user.rider_profile.work_address|truncatechars:40 }}</p>
                            </div>
                        {% endif %}
                        {% if not user.rider_profile.home_address and not user.rider_profile.work_address %}
                            <p class="text-muted mb-3">No saved locations yet</p>
                        {% endif %}
                    </div>
                    <a href="{% url 'profile' %}" class="btn btn-outline-primary">
                        <i class="fas fa-edit me-1"></i>Manage Locations
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Rides -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-lg mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="fas fa-history me-2"></i>Recent Rides
                    </h5>
                    <a href="{% url 'ride_history' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-list me-1"></i>View All
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_rides %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Fare</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ride in recent_rides %}
                                        <tr>
                                            <td>{{ ride.created_at|date:"d M, Y" }}</td>
                                            <td>{{ ride.pickup_address|truncatechars:20 }}</td>
                                            <td>{{ ride.dropoff_address|truncatechars:20 }}</td>
                                            <td class="fw-bold">â‚¹{{ ride.fare|default:"--" }}</td>
                                            <td>
                                                {% if ride.status == 'PENDING' %}
                                                    <span class="badge bg-warning">Pending</span>
                                                {% elif ride.status == 'ACCEPTED' %}
                                                    <span class="badge bg-info">Accepted</span>
                                                {% elif ride.status == 'STARTED' %}
                                                    <span class="badge bg-primary">In Progress</span>
                                                {% elif ride.status == 'COMPLETED' %}
                                                    <span class="badge bg-success">Completed</span>
                                                {% elif ride.status == 'CANCELLED' %}
                                                    <span class="badge bg-danger">Cancelled</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'ride_detail' ride.id %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=200&q=80" 
                                 alt="No rides" class="img-fluid rounded mb-3" style="max-height: 150px;">
                            <h5 class="text-muted mb-2">No rides yet</h5>
                            <p class="text-muted mb-3">Book your first ride to get started!</p>
                            <a href="{% url 'book_ride' %}" class="btn btn-primary">
                                <i class="fas fa-taxi me-2"></i>Book a Ride
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Recommendations & Quick Actions -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm rounded-lg mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <a href="{% url 'book_ride' %}" class="quick-action-card text-decoration-none">
                                <div class="card h-100 border-0 shadow-sm bg-light rounded-lg text-center">
                                    <div class="card-body p-3">
                                        <div class="quick-icon bg-primary text-white rounded-circle mx-auto mb-2">
                                            <i class="fas fa-taxi"></i>
                                        </div>
                                        <h6 class="mb-0 text-primary">Book Ride</h6>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'ride_history' %}" class="quick-action-card text-decoration-none">
                                <div class="card h-100 border-0 shadow-sm bg-light rounded-lg text-center">
                                    <div class="card-body p-3">
                                        <div class="quick-icon bg-info text-white rounded-circle mx-auto mb-2">
                                            <i class="fas fa-history"></i>
                                        </div>
                                        <h6 class="mb-0 text-primary">History</h6>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'profile' %}" class="quick-action-card text-decoration-none">
                                <div class="card h-100 border-0 shadow-sm bg-light rounded-lg text-center">
                                    <div class="card-body p-3">
                                        <div class="quick-icon bg-success text-white rounded-circle mx-auto mb-2">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <h6 class="mb-0 text-primary">Profile</h6>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="#" class="quick-action-card text-decoration-none">
                                <div class="card h-100 border-0 shadow-sm bg-light rounded-lg text-center">
                                    <div class="card-body p-3">
                                        <div class="quick-icon bg-warning text-white rounded-circle mx-auto mb-2">
                                            <i class="fas fa-headset"></i>
                                        </div>
                                        <h6 class="mb-0 text-primary">Support</h6>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Fare Estimate -->
            <div class="card border-0 shadow-sm rounded-lg mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="fas fa-calculator me-2"></i>Fare Estimate
                    </h5>
                </div>
                <div class="card-body">
                    <div class="fare-estimator p-3 bg-light rounded-lg">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="quickEstimatePickup" placeholder="Enter pickup location">
                            <label for="quickEstimatePickup">Pickup Location</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="quickEstimateDropoff" placeholder="Enter destination">
                            <label for="quickEstimateDropoff">Destination</label>
                        </div>
                        <button type="button" class="btn btn-primary w-100" id="calculateFareBtn">
                            <i class="fas fa-rupee-sign me-1"></i>Calculate Fare
                        </button>
                        
                        <div class="estimate-result mt-3 d-none" id="estimateResult">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded-lg shadow-sm">
                                <div>
                                    <h6 class="mb-1">Estimated Fare:</h6>
                                    <p class="mb-0 text-success fw-bold" id="estimatedFare">â‚¹150 - â‚¹200</p>
                                    <small class="text-muted" id="estimatedTime">-- km Â· -- mins</small>
                                </div>
                                <a href="{% url 'book_ride' %}" class="btn btn-primary btn-sm">
                                    Book Now
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
/* Header Styles */
.display-6 {
    font-size: 2.5rem;
}

/* Stats Icons */
.stats-icon {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

/* Active Ride Styling */
.active-ride-status {
    display: flex;
    align-items: center;
}

.pulse-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #28a745;
    box-shadow: 0 0 0 rgba(40, 167, 69, 0.4);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
    }
}

/* Quick Actions */
.quick-icon {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    margin-bottom: 0.75rem;
}

.quick-action-card:hover .card {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
}

.quick-action-card .card {
    transition: all 0.3s ease;
}

/* Table improvements */
.table {
    border-collapse: separate;
    border-spacing: 0;
}

.table th {
    font-weight: 600;
    white-space: nowrap;
}

.table td {
    vertical-align: middle;
}

.badge {
    padding: 0.5em 0.75em;
}

/* Form improvements */
.form-control:focus {
    box-shadow: 0 0 0 0.25rem rgba(106, 17, 203, 0.25);
    border-color: #2575fc;
}

.btn-primary {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a0cb6 0%, #1565e6 100%);
}

.btn-outline-primary {
    color: #6a11cb;
    border-color: #6a11cb;
}

.btn-outline-primary:hover {
    background-color: #6a11cb;
    border-color: #6a11cb;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Store Django context in a JSON template to avoid JavaScript linting issues
</script>
<script type="text/template" id="cabby-context">
{
    "user": {
        "id": {{ request.user.id }},
        "type": "rider"
    },
    "config": {
        "webSocket": {
            "port": {% if WEBSOCKET_PORT %}{{ WEBSOCKET_PORT }}{% else %}8001{% endif %}
        }
    }
}
</script>

<script>
// Global variables
let notificationSocket;

// Initialize configuration from Django context
const CABBY_CONFIG = (function() {
    try {
        const contextElement = document.getElementById('cabby-context');
        const context = JSON.parse(contextElement.textContent);
        return {
            urls: {
                bookRide: '/rides/book/',
                notifications: '/accounts/notifications/'
            },
            webSocket: {
                port: context.config.webSocket.port,
                retryInterval: 10000, // 10 seconds
                heartbeatInterval: 30000 // 30 seconds
            }
        };
    } catch (error) {
        console.error('Error initializing config:', error);
        return {
            urls: {
                bookRide: '/rides/book/',
                notifications: '/accounts/notifications/'
            },
            webSocket: {
                port: 8001,
                retryInterval: 10000,
                heartbeatInterval: 30000
            }
        };
    }
})();

// Set up real-time notification system
document.addEventListener('DOMContentLoaded', function() {
    // Setup notification WebSocket connection
    setupNotificationSocket();
    
    // Poll for notifications as fallback mechanism
    fetchNotifications();
});

function setupNotificationSocket() {
    // Create WebSocket connection for real-time notifications
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    // Use the dedicated WebSocket port from configuration
    const host = window.location.hostname + ':' + CABBY_CONFIG.webSocket.port;
    const wsUrl = `${wsProtocol}//${host}/notifications/`;
    
    // Close any existing connection
    if (notificationSocket) {
        notificationSocket.close();
    }
    
    try {
        notificationSocket = new WebSocket(wsUrl);
        
        notificationSocket.onopen = function(e) {
            console.log('WebSocket connection established');
            // Set up heartbeat to keep connection alive
            setInterval(function() {
                if (notificationSocket.readyState === WebSocket.OPEN) {
                    notificationSocket.send(JSON.stringify({
                        'type': 'heartbeat'
                    }));
                }
            }, CABBY_CONFIG.webSocket.heartbeatInterval);
        };
        
        notificationSocket.onmessage = function(e) {
            console.log('WebSocket message received:', e.data);
            const data = JSON.parse(e.data);
            
            // Handle different types of messages
            if (data.type === 'notification') {
                showNotification(data.message, data.level, data.actions);
            } else if (data.type === 'ride_status_update') {
                handleRideStatusUpdate(data);
            }
        };
        
        notificationSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
        
        notificationSocket.onclose = function(e) {
            console.log('WebSocket connection closed. Will try to reconnect in ' + 
                        (CABBY_CONFIG.webSocket.retryInterval / 1000) + ' seconds');
            // Try to reconnect after a delay
            setTimeout(function() {
                setupNotificationSocket();
            }, CABBY_CONFIG.webSocket.retryInterval);
        };
    } catch (error) {
        console.error('Error setting up WebSocket:', error);
        // Make sure we poll for notifications as fallback
        setTimeout(fetchNotifications, 5000);
    }
}

// Fallback: Poll for notifications when WebSockets aren't working
function fetchNotifications() {
    fetch('/api/notifications/')
        .then(response => response.json())
        .then(data => {
            if (data.notifications && data.notifications.length > 0) {
                data.notifications.forEach(notification => {
                    showNotification(notification.message, notification.level, notification.actions);
                });
            }
        })
        .catch(error => console.error('Error fetching notifications:', error));
}

function handleRideStatusUpdate(data) {
    // Show notification toast
    showNotificationToast('Ride Update', data.message, data.redirect_url);
    
    // If this is about an active ride, refresh the page to show the updated status
    const activeRideSection = document.getElementById('activeRideSection');
    const pendingRideSection = document.getElementById('pendingRideSection');
    
    if ((activeRideSection && !activeRideSection.classList.contains('d-none')) || 
        (pendingRideSection && !pendingRideSection.classList.contains('d-none'))) {
        // Reload the page to show updated ride status
        window.location.reload();
    }
}

function showNotificationToast(title, message, actionUrl) {
    // Create toast container if it doesn't exist
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // Create a unique ID for this toast
    const toastId = 'toast-' + Date.now();
    
    // Create toast HTML
    const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-primary text-white">
                <strong class="me-auto">${title}</strong>
                <small>Just now</small>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
                ${actionUrl ? `<div class="mt-2 pt-2 border-top">
                    <a href="${actionUrl}" class="btn btn-primary btn-sm">View Details</a>
                </div>` : ''}
            </div>
        </div>
    `;
    
    // Add the toast to the container
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Initialize and show the toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {delay: 5000});
    toast.show();
    
    // Play notification sound
    playNotificationSound();
    
    // Auto-remove toast from DOM after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// Play a notification sound
function playNotificationSound() {
    try {
        const audio = new Audio('/static/sounds/notification.mp3');
        audio.volume = 0.5;
        audio.play().catch(e => console.log('Audio play failed:', e));
    } catch (e) {
        console.log('Audio not supported');
    }
}

function initFareEstimator() {
    // Initialize the quick fare estimator
    const calculateFareBtn = document.getElementById('calculateFareBtn');
    if (calculateFareBtn) {
        calculateFareBtn.addEventListener('click', function() {
            const pickup = document.getElementById('quickEstimatePickup').value;
            const dropoff = document.getElementById('quickEstimateDropoff').value;
            
            if (pickup && dropoff) {
                // Show loading state
                calculateFareBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Calculating...';
                calculateFareBtn.disabled = true;
                
                // Use OSRM for route calculation (free alternative to Google Maps)
                geocodeLocation(pickup)
                    .then(pickupCoords => {
                        return geocodeLocation(dropoff)
                            .then(dropoffCoords => ({pickup: pickupCoords, dropoff: dropoffCoords}));
                    })
                    .then(coords => {
                        // Call OSRM for distance and duration
                        return fetch(`https://router.project-osrm.org/route/v1/driving/${coords.pickup.lng},${coords.pickup.lat};${coords.dropoff.lng},${coords.dropoff.lat}?overview=false`)
                            .then(response => response.json())
                            .then(data => {
                                const distance = data.routes[0].distance / 1000; // Convert to kilometers
                                const duration = Math.ceil(data.routes[0].duration / 60); // Convert to minutes
                                
                                // Calculate fare based on distance and time
                                // Base fare: â‚¹50, â‚¹12 per km, â‚¹2 per minute
                                const baseFare = 50;
                                const distanceFare = distance * 12;
                                const timeFare = duration * 2;
                                const estimatedFare = Math.round(baseFare + distanceFare + timeFare);
                                
                                // Show range (Â±10%)
                                const minFare = Math.round(estimatedFare * 0.9);
                                const maxFare = Math.round(estimatedFare * 1.1);
                                
                                // Update the UI
                                document.getElementById('estimateResult').classList.remove('d-none');
                                document.getElementById('estimatedFare').textContent = `â‚¹${minFare} - â‚¹${maxFare}`;
                                document.getElementById('estimatedTime').textContent = `${Math.round(distance)} km Â· ${Math.round(duration)} mins`;
                                
                                // Reset button state
                                calculateFareBtn.innerHTML = '<i class="fas fa-rupee-sign me-1"></i>Calculate Fare';
                                calculateFareBtn.disabled = false;
                            });
                    })
                    .catch(error => {
                        console.error('Error calculating fare:', error);
                        document.getElementById('estimateResult').classList.remove('d-none');
                        document.getElementById('estimatedFare').textContent = 'â‚¹150 - â‚¹200 (estimate)';
                        document.getElementById('estimatedTime').textContent = '-- km Â· -- mins';
                        calculateFareBtn.innerHTML = '<i class="fas fa-rupee-sign me-1"></i>Calculate Fare';
                        calculateFareBtn.disabled = false;
                    });
            } else {
                alert('Please enter both pickup and destination locations');
            }
        });
    }
    
    // Initialize places autocomplete
    initPlacesAutocomplete();
}

// Geocode location using Nominatim (OpenStreetMap's free geocoding service)
function geocodeLocation(address) {
    return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                return {
                    lat: parseFloat(data[0].lat),
                    lng: parseFloat(data[0].lon)
                };
            } else {
                throw new Error('Location not found');
            }
        });
}

// Initialize places autocomplete with custom implementation
function initPlacesAutocomplete() {
    const pickupInput = document.getElementById('quickEstimatePickup');
    const dropoffInput = document.getElementById('quickEstimateDropoff');
    
    if (pickupInput) {
        pickupInput.addEventListener('input', debounce(function() {
            const query = this.value;
            if (query.length > 3) {
                autocompleteSearch(query, pickupInput);
            }
        }, 500));
    }
    
    if (dropoffInput) {
        dropoffInput.addEventListener('input', debounce(function() {
            const query = this.value;
            if (query.length > 3) {
                autocompleteSearch(query, dropoffInput);
            }
        }, 500));
    }
}

// Autocomplete search using Nominatim
function autocompleteSearch(query, inputElement) {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            // Create datalist if it doesn't exist
            let datalistId = inputElement.id + '_list';
            let datalist = document.getElementById(datalistId);
            
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = datalistId;
                document.body.appendChild(datalist);
                inputElement.setAttribute('list', datalistId);
            }
            
            // Clear previous options
            datalist.innerHTML = '';
            
            // Add new options
            data.slice(0, 5).forEach(item => {
                const option = document.createElement('option');
                option.value = item.display_name;
                datalist.appendChild(option);
            });
        })
        .catch(error => console.error('Error fetching autocomplete suggestions:', error));
}

// Debounce function to limit API calls
function debounce(func, wait) {
    let timeout;
    return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            func.apply(context, args);
        }, wait);
    };
}
</script>
{% endblock %}